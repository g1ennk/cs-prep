# 동시성 문제 중 경쟁 상태를 해결하려면 무엇이 보장되어야 하나요

## 요약

### 경쟁 상태(Race Condition)란?

- 여러 스레드가 동시에 공유 자원에 접근하여 실행 순서에 따라 결과가 달라지는 상황을 말한다.
- 즉, 스레드 간의 비원자적 연산과 메모리 불일치 때문에 발생한다.
    ```java
    int count = 0;
    
    public void increase() {
        count++; // 여러 스레드가 동시 접근 시 race condition 발생
    }
    ```

### 경쟁 상태를 해결하려면?

- 경쟁 상태를 해결하려면 다음 3가지 조건이 보장되어야 한다.

| 구분                             | 설명                               | 대표 해결 방법                                 |
|--------------------------------|----------------------------------|------------------------------------------|
| **① 상호 배제 (Mutual Exclusion)** | 한 번에 하나의 스레드만 공유 자원에 접근해야 함      | `synchronized`, `ReentrantLock`          |
| **② 원자성 (Atomicity)**          | 연산이 더 이상 쪼갤 수 없는 하나의 단위로 수행되어야 함 | `AtomicInteger`, `Lock`, `synchronized`  |
| **③ 가시성 (Visibility)**         | 한 스레드의 변경이 다른 스레드에게 즉시 보이도록 해야 함 | `volatile`, `synchronized`, `Atomic` 클래스 |

### 원자성 문제 예시

- `원자성`은 공유 자원에 대한 작업의 단위가 더 이상 쪼갤 수 없는 하나의 연산처럼 동작하는 성질을 의미한다.
- `i++`은 실제로 다음 세 단계로 수행된다.
    - READ: 변수 값 읽기
    - MODIFY: 값 1 증가
    - WRITE: 변경된 값 다시 저장
- 연산 사이에 다른 스레드가 개입한다면 기대하지 않은 결과가 발생할 수 있다.

### 가시성 문제 예시

- `가시성`은 한 스레드에서 변경한 값이 다른 스레드에서 즉시 확인 가능한 성질을 의미한다.
- 스레드 A가 값을 변경해도, 스레드 B가 CPU 캐시에 있는 이전 값을 참조하면 변경 내용을 모를 수 있다.
- 즉, 메인 메모리에 즉시 반영되지 않아 최산 상태를 공유하지 못하는 현상이 발생한다.

### 자바에서의 해결 방법

| 구분                       | 보장 속성             | 설명                                                                   |
|--------------------------|-------------------|----------------------------------------------------------------------|
| `synchronized`           | 원자성 + 가시성 + 상호 배제 | 가장 기본적인 동기화 방법. 블록 단위로 Lock을 걸어 한 번에 하나의 스레드만 접근 가능                  |
| `ReentrantLock`          | 원자성 + 가시성 + 상호 배제 | `synchronized`보다 세밀한 제어 가능 (tryLock, 조건 대기 등)                        |
| `Atomic 클래스`             | 원자성 + 가시성         | 내부적으로 CAS(Compare-And-Swap)를 사용하여 비차단 동기화 수행                         |
| `volatile`               | 가시성               | CPU 캐시가 아닌 메인 메모리에서 직접 읽고 씀으로써 변경사항 즉시 반영                            |
| `Concurrent Collections` | 원자성 + 가시성         | 멀티스레드 환경에서 안전한 자료구조 제공 (`ConcurrentHashMap`, `CopyOnWriteArrayList`) |

## 발화

경쟁 상태란, 여러 스레드가 동시에 공유 자원에 접근해서 실행 순서에 따라 결과가 달라지는 상황을 말합니다.

이 문제를 해결하기 위해선 세 가지가 보장되어야 합니다.

첫 번째로는 상호 배제로 하나의 한 번의 하나의 스레드만 공유 자원에 접근해야합니다.

두 번째로는 원자성으로 연산이 쪼갤 수 없는 작은 단위로 이루어져 하나의 단위로 수행되어야 합니다.

마지막으로 가시성은 한 스레드에서 변경한 값이 즉시 다른 스레드에서 볼 수 있어야 합니다.

자바에서는 각각 synchronized, Atomic 클래스, volatile 키워드 등을 통해 문제를 해결할 수 있습니다.

경쟁 상태의 핵심은 동시 접근을 제어하고, 메모리 일관성을 유지하는 것이 핵심입니다.
